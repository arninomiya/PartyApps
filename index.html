<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ„å¤–ã¨çŸ¥ã‚‰ãªã„ Copilot ã‚¯ã‚¤ã‚ºï¼ˆ7å•ï¼‰</title>

  <!-- è¦‹ãŸç›®ï¼ˆè»½é‡ï¼‰ -->
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --card2:#0f172a; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#60a5fa; --good:#34d399; --bad:#f87171; --warn:#fbbf24; --line:rgba(255,255,255,.12);
      --shadow:0 16px 60px rgba(0,0,0,.35);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:linear-gradient(180deg,#070b15,#0b1220 40%,#070b15);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;}
    a{color:var(--accent);}
    .wrap{max-width:1120px;margin:0 auto;padding:24px;}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#60a5fa,#34d399);box-shadow:0 10px 30px rgba(96,165,250,.25);}
    h1{font-size:18px;margin:0;}
    .muted{color:var(--muted);font-size:13px;}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);
      background:rgba(255,255,255,.04);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted);}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;}
    @media(min-width:900px){ .grid.two{grid-template-columns:1.25fr .75fr;} }
    .card{background:rgba(18,26,43,.82);border:1px solid var(--line);border-radius:16px;padding:16px;
      box-shadow:var(--shadow);backdrop-filter: blur(8px);}
    .card h2{font-size:16px;margin:0 0 10px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    input{background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;outline:none;min-width:180px;}
    input::placeholder{color:rgba(229,231,235,.35);}
    button{cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.07);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:700;}
    button.primary{background:linear-gradient(135deg,rgba(96,165,250,.95),rgba(52,211,153,.95));border:none;color:#051018;}
    button.danger{background:rgba(248,113,113,.18);border:1px solid rgba(248,113,113,.35);}
    button:disabled{opacity:.45;cursor:not-allowed;}
    .sep{height:1px;background:var(--line);margin:14px 0;}
    .qbox{padding:14px;border-radius:14px;background:rgba(15,23,42,.7);border:1px solid var(--line);}
    .qnum{font-size:12px;color:var(--muted);margin-bottom:8px;}
    .qtext{font-size:18px;line-height:1.45;margin:0 0 12px;}
    .choices{display:grid;gap:10px;}
    .choice{display:flex;gap:10px;align-items:flex-start;text-align:left;border:1px solid var(--line);
      border-radius:14px;background:rgba(255,255,255,.04);padding:12px;cursor:pointer;}
    .choice:hover{background:rgba(255,255,255,.06);}
    .choice.selected{border-color:rgba(96,165,250,.7);background:rgba(96,165,250,.12);}
    .badge{min-width:28px;height:28px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      background:rgba(96,165,250,.18);border:1px solid rgba(96,165,250,.35);font-weight:900;}
    .toast{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.06);font-size:13px;}
    .toast.good{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12);}
    .toast.bad{border-color:rgba(248,113,113,.35);background:rgba(248,113,113,.12);}
    .toast.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.10);}
    .hidden{display:none;}
    .mono{font-family:var(--mono);}
    canvas{max-width:100%;}
    .leader{display:flex;flex-direction:column;gap:10px;}
    .leader .item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid var(--line);}
    .rank{display:flex;gap:10px;align-items:center;}
    .rank .n{width:26px;height:26px;border-radius:9px;background:rgba(96,165,250,.18);border:1px solid rgba(96,165,250,.35);
      display:flex;align-items:center;justify-content:center;font-weight:900;}
    .footer{margin-top:18px;color:rgba(229,231,235,.35);font-size:12px;line-height:1.6;}
  </style>

  <!-- QRç”Ÿæˆï¼ˆCDNï¼‰ã€‚ã‚‚ã—ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§å¼¾ã‹ã‚ŒãŸã‚‰URLæ–‡å­—åˆ—ã‚’é…å¸ƒã§ä»£æ›¿ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>æ„å¤–ã¨çŸ¥ã‚‰ãªã„ Copilot ã‚¯ã‚¤ã‚ºï¼ˆ7å•ãƒ»3æŠï¼‰</h1>
        <div class="muted">å‚åŠ è€…ï¼šæŠ•ç¥¨ / è¡¨ç¤ºï¼šQRï¼‹é›†è¨ˆï¼ˆåŒã˜HTMLï¼‰</div>
      </div>
    </div>
    <div class="row">
      <span class="pill">ãƒ¢ãƒ¼ãƒ‰: <b id="modePill">participant</b></span>
      <span class="pill">Room: <b id="roomPill">-</b></span>
      <span class="pill">æ¥ç¶š: <b id="connPill">æœªæ¥ç¶š</b></span>
    </div>
  </div>

  <div class="grid two">
    <!-- å·¦ï¼šãƒ¡ã‚¤ãƒ³ -->
    <div class="card">
      <h2 id="mainTitle">å‚åŠ è€…ï¼šå‚åŠ ãƒ»æŠ•ç¥¨</h2>
      <div id="banner" class="toast warn hidden"></div>

      <!-- å‚åŠ  -->
      <div id="joinPanel">
        <div class="row">
          <input id="roomInput" placeholder="RoomIdï¼ˆä¾‹: ABC123ï¼‰" />
          <input id="nickInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " />
          <button class="primary" id="joinBtn">å‚åŠ ã™ã‚‹</button>
          <button id="resetBtn" class="danger">ãƒªã‚»ãƒƒãƒˆï¼ˆã“ã®ç«¯æœ«ï¼‰</button>
        </div>
        <div class="muted" style="margin-top:10px;">
          URLã« <span class="mono">?room=ABC123</span> ãŒä»˜ã„ã¦ã„ã‚Œã°è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã€‚<br/>
          å‚åŠ å¾Œã¯ã“ã®ç«¯æœ«ã§ <b>å„å•1å›</b>ã ã‘æŠ•ç¥¨ã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="sep"></div>

      <!-- ã‚¯ã‚¤ã‚º -->
      <div id="quizPanel" class="hidden">
        <div class="qbox">
          <div class="qnum"><span id="qCounter">Q1/7</span> <span class="muted">ï¼ˆæŠ•ç¥¨ã¯1å•ã«ã¤ã1å›ï¼‰</span></div>
          <p class="qtext" id="qText">-</p>
          <div class="choices" id="choices"></div>
          <div style="margin-top:12px;" class="row">
            <button id="prevBtn">å‰ã¸</button>
            <button id="nextBtn" class="primary">æ¬¡ã¸</button>
            <span class="muted" id="voteHint">æŠ•ç¥¨ã™ã‚‹ã¨æ¬¡ã¸é€²ã‚ã¾ã™</span>
          </div>
        </div>

        <div style="margin-top:12px;" class="row">
          <span class="pill">ã‚ãªãŸ: <b id="mePill">-</b></span>
          <span class="pill">æŠ•ç¥¨: <b id="progressPill">0/7</b></span>
          <span class="pill">room: <b class="mono" id="roomEcho">-</b></span>
        </div>

        <div id="toastArea" style="margin-top:12px;"></div>
      </div>

      <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
      <div id="displayPanel" class="hidden">
        <div class="row">
          <div>
            <div class="muted">å‚åŠ URLï¼ˆé…å¸ƒç”¨ï¼‰</div>
            <div class="mono" id="joinUrlText" style="font-size:14px;"></div>
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <canvas id="qrCanvas" width="180" height="180" style="background:#fff;border-radius:12px;"></canvas>
          <div class="muted">
            QRãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ä¸Šã®URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚<br/>
            <span class="mono">?mode=display&room=ROOM</span> ã§è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã€‚
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between;align-items:flex-end;">
          <div>
            <h2 style="margin:0;">é›†è¨ˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</h2>
            <div class="muted">â€» <span class="mono">/api/results?roomId=...</span> ãŒã‚ã‚Œã°è¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
          <button id="refreshResultsBtn">çµæœã‚’æ›´æ–°</button>
        </div>

        <div class="grid two" style="margin-top:12px;">
          <div class="card" style="background:rgba(15,23,42,.55);">
            <h2 style="margin-top:0;">å•é¡Œã”ã¨ã®æ­£è§£æ•°</h2>
            <canvas id="barCanvas" height="240"></canvas>
            <div class="muted">ï¼ˆå·¦ãŒQ1ã€å³ãŒQ7ï¼‰</div>
          </div>
          <div class="card" style="background:rgba(15,23,42,.55);">
            <h2 style="margin-top:0;">æ­£è§£æ•° Top5</h2>
            <div class="leader" id="leaderboard"></div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>âœ… å‚åŠ è€…UIï¼šGitHub Pages / å¸ä¼šUIï¼šAzure Adminï¼ˆEasy Authï¼‰æƒ³å®š</div>
        <div>âœ… CORS ã¯ãƒ›ã‚¹ãƒˆï¼ˆ<span class="mono">https://arninomiya.github.io</span>ï¼‰ã‚’è¨±å¯ã—ã¦ã„ã‚‹å‰æ[4](https://note.com/ai__worker/n/n02704e6cd5b3)</div>
      </div>
    </div>

    <!-- å³ï¼šãƒ‡ãƒãƒƒã‚° -->
    <div class="card">
      <h2>çŠ¶æ…‹ / ãƒ‡ãƒãƒƒã‚°</h2>
      <div class="muted">ã‚¤ãƒ™ãƒ³ãƒˆå½“æ—¥ã¯é–‰ã˜ã¦ã‚‚OKï¼ˆè©°ã¾ã£ãŸæ™‚ã®åˆ‡ã‚Šåˆ†ã‘ç”¨ï¼‰</div>
      <div class="sep"></div>

      <div class="row">
        <button id="connectBtn">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶š</button>
        <button id="disconnectBtn">åˆ‡æ–­</button>
      </div>

      <div style="margin-top:10px;" class="toast">
        <div><b>Public API</b></div>
        <div class="mono" id="apiBaseText">-</div>
      </div>

      <div style="margin-top:10px;" class="toast">
        <div><b>localStorage</b></div>
        <div class="mono" id="lsText">-</div>
      </div>

      <div style="margin-top:10px;" class="toast">
        <div><b>å—ä¿¡ãƒ­ã‚°ï¼ˆWeb PubSubï¼‰</b></div>
        <div class="mono" id="logBox" style="white-space:pre-wrap;max-height:320px;overflow:auto;">-</div>
      </div>
    </div>
  </div>
</div>

<script>
/** =========================================================
 * âœ… ã“ã“ã ã‘å¿…ãšç½®æ›ï¼šã‚ãªãŸã® Public Function ã® API ãƒ™ãƒ¼ã‚¹URL
 * ä¾‹: https://func-quiz-public-2286425999.azurewebsites.net/api
 * ========================================================= */
const API_BASE = "https://func-quiz-public-2286425999.azurewebsites.net/api";

/** =========================================================
 * ã‚¯ã‚¤ã‚ºï¼ˆ7å•ãƒ»3æŠï¼‰â€»å¿…è¦ãªã‚‰å·®ã—æ›¿ãˆ
 * ========================================================= */
const QUIZ = [
  {
    q: "Copilot ãŒä½œã£ãŸæ–‡ç« ã‚„è³‡æ–™ã®â€œæ¨©åˆ©â€ã¯ã€ã©ã†è€ƒãˆã‚‹ã®ãŒè‡ªç„¶ï¼Ÿ",
    a: ["ãŠå®¢æ§˜ã®ã‚‚ã®", "ãƒ™ãƒ³ãƒ€ãƒ¼ã®ã‚‚ã®", "AIã®ã‚‚ã®"],
    correct: 0,
    explainHtml:
      "ã€è§£èª¬ã€‘<br>" +
      "ç”Ÿæˆç‰©ã¯åŸºæœ¬çš„ã«ãŠå®¢æ§˜å´ã®æˆæœç‰©ã¨ã—ã¦æ‰±ã†ã®ãŒè‡ªç„¶ã§ã™ã€‚<br>" +
      "è‘—ä½œæ¨©ãƒ»åˆ©ç”¨ä¸Šã®å®‰å¿ƒææ–™ï¼ˆã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆç­‰ï¼‰ãŒæ•´ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚"
  },
  {
    q: "ğŸª¤ Copilotã¯ã€Œä¼šç¤¾ã®æƒ…å ±ãªã‚‰ä½•ã§ã‚‚å‹æ‰‹ã«èª­ã‚ã‚‹ã€ï¼Ÿ",
    a: ["å…¨éƒ¨ã‚’èª­ã‚ã‚‹", "æ¨©é™ã®ç¯„å›²", "ä¸€éƒ¨ã ã‘èª­ã‚ã‚‹"],
    correct: 1,
    explainHtml:
      "ã€è§£èª¬ã€‘<br>" +
      "Copilotã¯â€œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ç¯„å›²â€ã§å‹•ãã¾ã™ã€‚<br>" +
      "æ¨©é™ãŒãªã„æƒ…å ±ã¯å–å¾—ã—ã¾ã›ã‚“ã€‚"
  },
  {
    q: "Microsoft 365 Copilot ã«å…¥åŠ›ã—ãŸç¤¾å†…æƒ…å ±ã¯ã€AIã®å­¦ç¿’ã«ä½¿ã‚ã‚Œã‚‹ï¼Ÿ",
    a: ["å­¦ç¿’ã«ä½¿ã†", "å­¦ç¿’ã«ä½¿ã‚ãªã„", "å ´åˆã§å¤‰ã‚ã‚‹"],
    correct: 1,
    explainHtml:
      "ã€è§£èª¬ã€‘<br>" +
      "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„å¿œç­”ã€å‚ç…§ã—ãŸç¤¾å†…ãƒ‡ãƒ¼ã‚¿ã¯ã€åŸºç›¤ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã«ä½¿ã‚ã‚Œãªã„å‰æã§ã™ã€‚<br>" +
      "â€œå…¥åŠ›ãŒå­¦ç¿’ã«å›ã‚‰ãªã„â€ãŒé‡è¦ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚"
  },
  {
    q: "Azure AI Foundryã§ä½¿ãˆã‚‹ã€ŒAIã®ç¨®é¡ï¼ˆãƒ¢ãƒ‡ãƒ«ï¼‰ã€ã®æ•°ã®è¦æ¨¡æ„Ÿã¯ï¼Ÿ",
    a: ["1,000è¶…ãã‚‰ã„", "10,000è¶…ãã‚‰ã„", "100,000è¶…ãã‚‰ã„"],
    correct: 1,
    explainHtml:
      "ã€è§£èª¬ã€‘<br>" +
      "è¦æ¨¡æ„Ÿã¨ã—ã¦ã¯ã€Œ10,000è¶…ã€ãŒæœ€ã‚‚è¿‘ã„ã§ã™ã€‚<br>" +
      "é‡è¦ãªã®ã¯â€œæ•°â€ã‚ˆã‚Šã‚‚ã€æ¬¡ã®Q5ã®ã‚ˆã†ã«çµ±åˆ¶ã§ãã‚‹ã“ã¨ã§ã™ã€‚"
  },
  {
    q: "ã€Œä½¿ã£ã¦ã„ã„AIã ã‘ã€ã«çµã£ã¦ã€ç¾å ´ã®â€œå‹æ‰‹åˆ©ç”¨â€ã‚’é˜²ãã«ã¯ï¼Ÿ",
    a: ["è¨±å¯ã—ãŸAIã ã‘", "å„éƒ¨é–€ã«ä»»ã›ã‚‹", "ä½¿ã£ã¦ã‹ã‚‰ç›£æŸ»"],
    correct: 0,
    explainHtml:
      "ã€è§£èª¬ã€‘<br>" +
      "è¨±å¯ã—ãŸAIï¼ˆãƒ¢ãƒ‡ãƒ«ï¼‰ã ã‘ã‚’â€œä½¿ãˆã‚‹åŒ–â€ã™ã‚‹é‹ç”¨ãŒæœ€ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„çµ±åˆ¶ã§ã™ã€‚<br>" +
      "è¨±å¯ãƒªã‚¹ãƒˆå¤–ã¯ä½¿ãˆãªã„çŠ¶æ…‹ã«å¯„ã›ã‚‰ã‚Œã¾ã™ã€‚"
  },
  {
    q: "Azure AI Foundryï¼ˆAzureä¸Šã§ç›´æ¥æä¾›ã•ã‚Œã‚‹AIï¼‰ã«å…¥ã‚ŒãŸå†…å®¹ã¯ã€å¤–éƒ¨ã®AIä¼šç¤¾ã«æ¸¡ã‚‹ï¼Ÿ",
    a: ["å¤–éƒ¨ã«æ¸¡ã‚‹", "å¤–éƒ¨ã«æ¸¡ã‚‰ãªã„", "æ¡ä»¶ã§å¤‰ã‚ã‚‹"],
    correct: 1,
    explainHtml:
      "ã€è§£èª¬ã€‘<br>" +
      "Azure Direct ã®å‰æã§ã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ/å‡ºåŠ›ã¯ä»–ç¤¾ï¼ˆæä¾›è€…ã‚’å«ã‚€ï¼‰ã«å…±æœ‰ã•ã‚Œãªã„æ•´ç†ã§ã™ã€‚<br>" +
      "å¤–éƒ¨ã«æ¸¡ã‚‰ãªã„è¨­è¨ˆãƒ»æ˜è¨˜ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚"
  },
  {
    q: "ğŸª¤ ã€ŒAIã¯è¦šãˆãªã„ã€ï¼ ã ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã¯ä¸€åˆ‡ä¿å­˜ã•ã‚Œãªã„ï¼Ÿ",
    a: ["ã„ã¤ã‚‚ä¿å­˜ãªã—", "æ©Ÿèƒ½ã§å¤‰ã‚ã‚‹", "ã„ã¤ã‚‚ä¿å­˜ã‚ã‚Š"],
    correct: 1,
    explainHtml:
      "ã€è§£èª¬ã€‘<br>" +
      "â€œè¦šãˆãªã„ï¼ˆå­¦ç¿’ã—ãªã„ï¼‰â€ã¨â€œä¿å­˜ã—ãªã„â€ã¯åˆ¥ã§ã™ã€‚<br>" +
      "Threadsç­‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã§ã¯å±¥æ­´ãªã©ã®ä¿å­˜ãŒç™ºç”Ÿã—ã¾ã™ã€‚"
  }
];
const state = {
  mode: "participant",  // participant | display
  roomId: "",
  nickname: "",
  participantId: "",
  joinToken: "",
  ws: null,
  currentIndex: 0,
  voted: new Set(),     // æŠ•ç¥¨æ¸ˆã¿ qIndex
  lastResults: null,
  resultsTimer: null
};

const $ = (id)=>document.getElementById(id);

// DOM
const modePill=$("modePill"), roomPill=$("roomPill"), connPill=$("connPill");
const mainTitle=$("mainTitle"), banner=$("banner");
const joinPanel=$("joinPanel"), roomInput=$("roomInput"), nickInput=$("nickInput");
const joinBtn=$("joinBtn"), resetBtn=$("resetBtn");
const quizPanel=$("quizPanel"), qCounter=$("qCounter"), qText=$("qText"), choices=$("choices");
const prevBtn=$("prevBtn"), nextBtn=$("nextBtn"), voteHint=$("voteHint");
const mePill=$("mePill"), progressPill=$("progressPill"), roomEcho=$("roomEcho");
const toastArea=$("toastArea");
const displayPanel=$("displayPanel"), joinUrlText=$("joinUrlText"), qrCanvas=$("qrCanvas");
const barCanvas=$("barCanvas"), leaderboard=$("leaderboard"), refreshResultsBtn=$("refreshResultsBtn");
const connectBtn=$("connectBtn"), disconnectBtn=$("disconnectBtn");
const apiBaseText=$("apiBaseText"), lsText=$("lsText"), logBox=$("logBox");

// utils
function log(msg){ const t=new Date().toLocaleTimeString(); logBox.textContent=`[${t}] ${msg}\n`+logBox.textContent; }
function showBanner(type, text){ banner.className=`toast ${type}`; banner.textContent=text; banner.classList.remove("hidden"); }
function clearBanner(){ banner.classList.add("hidden"); }
function showToast(type, text){
  const d=document.createElement("div");
  d.className=`toast ${type}`;
  d.textContent=text;
  toastArea.prepend(d);
  setTimeout(()=>d.remove(), 6000);
}

function saveLocal(){
  const obj={ roomId:state.roomId, nickname:state.nickname, participantId:state.participantId,
    joinToken:state.joinToken, voted:Array.from(state.voted) };
  localStorage.setItem("quizState", JSON.stringify(obj));
  renderLocalStorage();
}
function loadLocal(){
  try{
    const raw=localStorage.getItem("quizState");
    if(!raw) return;
    const obj=JSON.parse(raw);
    state.roomId=obj.roomId||"";
    state.nickname=obj.nickname||"";
    state.participantId=obj.participantId||"";
    state.joinToken=obj.joinToken||"";
    state.voted=new Set(obj.voted||[]);
  }catch(_){}
}
function resetLocal(){
  localStorage.removeItem("quizState");
  state.roomId=""; state.nickname=""; state.participantId=""; state.joinToken="";
  state.voted=new Set(); state.currentIndex=0;
  renderAll();
}
function renderLocalStorage(){
  const raw=localStorage.getItem("quizState");
  lsText.textContent = raw ? raw.slice(0,220)+(raw.length>220?"...":"") : "(empty)";
}
function getQuery(){
  const u=new URL(location.href);
  return { mode:(u.searchParams.get("mode")||"").toLowerCase(), room:u.searchParams.get("room")||"" };
}

async function apiPost(path, body){
  const res=await fetch(`${API_BASE}/${path}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body||{})
  });
  return res;
}

// init
function init(){
  apiBaseText.textContent = API_BASE;

  const q=getQuery();
  if(q.room) roomInput.value=q.room;

  if(q.mode==="display"){
    state.mode="display";
    modePill.textContent="display";
    mainTitle.textContent="è¡¨ç¤ºï¼šQRï¼‹é›†è¨ˆ";
    joinPanel.classList.add("hidden");
    quizPanel.classList.add("hidden");
    displayPanel.classList.remove("hidden");
  }else{
    state.mode="participant";
    modePill.textContent="participant";
    displayPanel.classList.add("hidden");
  }

  loadLocal();
  if(state.roomId) roomInput.value=state.roomId;
  if(state.nickname) nickInput.value=state.nickname;

  joinBtn.onclick=join;
  resetBtn.onclick=()=>{ disconnectRealtime(); resetLocal(); };

  prevBtn.onclick=()=>{ if(state.currentIndex>0){ state.currentIndex--; renderQuiz(); } };
  nextBtn.onclick=()=>{ if(state.currentIndex<QUIZ.length-1){ state.currentIndex++; renderQuiz(); } };

  connectBtn.onclick=connectRealtime;
  disconnectBtn.onclick=disconnectRealtime;
  refreshResultsBtn.onclick=fetchResults;

  // display mode: roomãŒå…¥ã£ã¦ãŸã‚‰QRç”Ÿæˆ
  if(state.mode==="display"){
    const rid = (q.room || state.roomId || "").trim();
    if(rid){
      state.roomId = rid;
      roomPill.textContent = rid;
      renderDisplay();
      connectRealtime();
    }else{
      showBanner("warn","è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¯ URL ã« ?room=XXXX ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚");
    }
  }

  renderAll();
  renderLocalStorage();
}

// join
async function join(){
  clearBanner();
  const roomId=roomInput.value.trim();
  const nickname=nickInput.value.trim();
  if(!roomId || !nickname){
    showBanner("warn","RoomId ã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  joinBtn.disabled=true;
  try{
    const res=await apiPost("join",{roomId, nickname});
    const text=await res.text();
    if(!res.ok) throw new Error(text);
    const data=JSON.parse(text);

    state.roomId=roomId;
    state.nickname=nickname;
    state.participantId=data.participantId||"";
    state.joinToken=data.joinToken||"";
    saveLocal();

    showToast("good","å‚åŠ OKï¼æŠ•ç¥¨ã§ãã¾ã™ã€‚");
    renderAll();
    await connectRealtime();
  }catch(e){
    showBanner("bad",`join å¤±æ•—: ${e.message}`);
  }finally{
    joinBtn.disabled=false;
  }
}

// quiz render
function renderQuiz(){
  roomPill.textContent = state.roomId || "-";
  roomEcho.textContent = state.roomId || "-";
  mePill.textContent = state.nickname ? state.nickname : "-";
  progressPill.textContent = `${state.voted.size}/7`;

  if(!state.joinToken){
    quizPanel.classList.add("hidden");
    return;
  }
  quizPanel.classList.remove("hidden");

  const q=QUIZ[state.currentIndex];
  qCounter.textContent=`Q${state.currentIndex+1}/7`;
  qText.textContent=q.q;
  choices.innerHTML="";

  const letters=["A","B","C"];
  q.a.forEach((t,i)=>{
    const div=document.createElement("div");
    div.className="choice";
    if(state.voted.has(state.currentIndex)) div.classList.add("locked");
    div.onclick=()=>{
      if(state.voted.has(state.currentIndex)) return;
      [...choices.querySelectorAll(".choice")].forEach(x=>x.classList.remove("selected"));
      div.classList.add("selected");
      div.dataset.selected="1";
    };
    div.innerHTML=`<div class="badge">${letters[i]}</div><div>${escapeHtml(t)}</div>`;
    choices.appendChild(div);
  });

  // æŠ•ç¥¨æ¸ˆã¿ãªã‚‰ãƒ’ãƒ³ãƒˆå¤‰æ›´
  if(state.voted.has(state.currentIndex)){
    voteHint.textContent="æŠ•ç¥¨æ¸ˆã¿ï¼ˆã“ã®å•ã¯å†æŠ•ç¥¨ä¸å¯ï¼‰";
  }else{
    voteHint.textContent="æŠ•ç¥¨ã—ã¦ã‹ã‚‰æ¬¡ã¸é€²ã‚ã¾ã™";
  }

  nextBtn.disabled = (state.currentIndex<QUIZ.length-1) && !state.voted.has(state.currentIndex);
  prevBtn.disabled = state.currentIndex===0;
}

// vote
async function submitVote(choiceIndex){
  if(!state.joinToken) return;
  if(state.voted.has(state.currentIndex)){
    showToast("warn","ã“ã®å•é¡Œã¯æŠ•ç¥¨æ¸ˆã¿ã§ã™ã€‚");
    return;
  }

  const correct = (choiceIndex === QUIZ[state.currentIndex].correct);

  // é€ä¿¡
  try{
    const res=await apiPost("vote",{
      joinToken:state.joinToken,
      qIndex:state.currentIndex,
      choice:choiceIndex,
      correct
    });
    if(res.status===409){
      state.voted.add(state.currentIndex);
      saveLocal();
      showToast("warn","æŠ•ç¥¨æ¸ˆã¿ï¼ˆã‚µãƒ¼ãƒåˆ¤å®šï¼‰ã§ã—ãŸã€‚");
      renderQuiz();
      return;
    }
    const text=await res.text();
    if(!res.ok) throw new Error(text);

    state.voted.add(state.currentIndex);
    saveLocal();
    showToast(correct?"good":"bad", correct?"æ­£è§£ï¼":"æ®‹å¿µã€ä¸æ­£è§£");
    renderQuiz();

    // æ¬¡ã¸é€²ã‚ã‚‹
    if(state.currentIndex<QUIZ.length-1) nextBtn.disabled=false;
  }catch(e){
    showToast("bad",`æŠ•ç¥¨å¤±æ•—: ${e.message}`);
  }
}

// choices click -> vote button
function wireVote(){
  // choices ã‹ã‚‰ selected ã‚’æ‹¾ã£ã¦æŠ•ç¥¨
  const selected = choices.querySelector(".choice.selected");
  if(!selected){ showToast("warn","é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
  // indexã¯é †ç•ªã§å–ã‚‹
  const all=[...choices.querySelectorAll(".choice")];
  const idx=all.indexOf(selected);
  submitVote(idx);
}

// realtime
async function connectRealtime(){
  clearBanner();
  if(state.ws && state.ws.readyState===1){
    showToast("warn","ã™ã§ã«æ¥ç¶šã—ã¦ã„ã¾ã™ã€‚");
    return;
  }
  if(!state.roomId){
    showToast("warn","RoomId ãŒå¿…è¦ã§ã™ã€‚");
    return;
  }

  try{
    const res=await apiPost("negotiate",{});
    const text=await res.text();
    if(!res.ok) throw new Error(text);
    const {url}=JSON.parse(text);
    const ws=new WebSocket(url);
    state.ws=ws;

    ws.onopen=()=>{ connPill.textContent="æ¥ç¶š"; log("WebPubSub connected"); };
    ws.onclose=()=>{ connPill.textContent="æœªæ¥ç¶š"; log("WebPubSub closed"); };
    ws.onerror=()=>{ connPill.textContent="æœªæ¥ç¶š"; log("WebPubSub error"); };
    ws.onmessage=(e)=>{
      log("msg: "+e.data);
      // é€ä¿¡å´ã¯ JSON {type:"vote" | "state", roomId, ...} ã‚’æƒ³å®š
      try{
        const obj=JSON.parse(e.data);
        if(obj.type==="state" && obj.roomId===state.roomId){
          // å¸ä¼šãŒ results ã«åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ display ã¯è‡ªå‹•æ›´æ–°
          if(obj.phase==="results" && state.mode==="display") fetchResults();
        }
        if(obj.type==="vote" && obj.roomId===state.roomId && state.mode==="display"){
          // é€£æ‰“ã—ãªã„ãŸã‚ debounce
          debounceFetchResults();
        }
      }catch(_){}
    };

  }catch(e){
    showBanner("bad",`ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šå¤±æ•—: ${e.message}`);
  }
}

function disconnectRealtime(){
  if(state.ws){ try{ state.ws.close(); }catch(_){} }
  state.ws=null;
  connPill.textContent="æœªæ¥ç¶š";
}

function debounceFetchResults(){
  if(state.resultsTimer) clearTimeout(state.resultsTimer);
  state.resultsTimer=setTimeout(fetchResults, 700);
}

// display render
function renderDisplay(){
  const joinUrl = `${location.origin}${location.pathname}?room=${encodeURIComponent(state.roomId)}`;
  joinUrlText.textContent = joinUrl;
  roomPill.textContent = state.roomId;

  try{
    if(window.QRCode){
      QRCode.toCanvas(qrCanvas, joinUrl, {width:180, margin:1}, (err)=>{
        if(err) showToast("warn","QRç”Ÿæˆã«å¤±æ•—ã€‚URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚");
      });
    }else{
      showToast("warn","QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­è¾¼ã€‚URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚");
    }
  }catch(_){
    showToast("warn","QRç”Ÿæˆã«å¤±æ•—ã€‚URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚");
  }

  // åˆå›çµæœ
  fetchResults();
}

// results
async function fetchResults(){
  if(!state.roomId){ showToast("warn","RoomId ãŒå¿…è¦ã§ã™ã€‚"); return; }
  try{
    const res=await fetch(`${API_BASE}/results?roomId=${encodeURIComponent(state.roomId)}`);
    if(!res.ok){
      // results APIãŒç„¡ã„ãªã‚‰ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
      drawPlaceholderCharts(`results API æœªå®Ÿè£…/å–å¾—ä¸å¯ï¼ˆ${res.status}ï¼‰`);
      return;
    }
    const data=await res.json();
    // æƒ³å®š: { perQuestion:[..7], top5:[{nickname,correctCount}], totalPlayers, totalVotes }
    drawCharts(data);
  }catch(e){
    drawPlaceholderCharts("results å–å¾—ã‚¨ãƒ©ãƒ¼");
  }
}

function drawPlaceholderCharts(msg){
  // bar
  const ctx=barCanvas.getContext("2d");
  const w=barCanvas.width=barCanvas.clientWidth*devicePixelRatio;
  const h=barCanvas.height=260*devicePixelRatio;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="rgba(255,255,255,.6)";
  ctx.font=`${14*devicePixelRatio}px sans-serif`;
  ctx.fillText(msg, 12*devicePixelRatio, 26*devicePixelRatio);

  leaderboard.innerHTML = `<div class="muted">Top5 è¡¨ç¤ºã«ã¯ results API ãŒå¿…è¦ã§ã™</div>`;
}

function drawCharts(data){
  // KPIï¼ˆã‚ã‚Œã°ï¼‰
  const per = data?.perQuestion || [0,0,0,0,0,0,0];
  const top = data?.top5 || [];

  // bar canvas
  const ctx=barCanvas.getContext("2d");
  const w=barCanvas.width=barCanvas.clientWidth*devicePixelRatio;
  const h=barCanvas.height=260*devicePixelRatio;
  ctx.clearRect(0,0,w,h);

  const pad=28*devicePixelRatio;
  const bw=(w-pad*2)/per.length;
  const max=Math.max(1,...per);

  // baseline
  ctx.strokeStyle="rgba(255,255,255,.18)";
  ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();

  per.forEach((v,i)=>{
    const x=pad+i*bw+bw*0.18;
    const barW=bw*0.64;
    const barH=(h-pad*1.5)*(v/max);
    const y=(h-pad)-barH;

    ctx.fillStyle="rgba(96,165,250,.75)";
    ctx.fillRect(x,y,barW,barH);

    ctx.fillStyle="rgba(255,255,255,.55)";
    ctx.font=`${11*devicePixelRatio}px sans-serif`;
    ctx.fillText(`Q${i+1}`, x, h-pad+14*devicePixelRatio);
    ctx.fillText(String(v), x, y-6*devicePixelRatio);
  });

  // Top5
  leaderboard.innerHTML="";
  const list = top.slice(0,5);
  if(list.length===0){
    leaderboard.innerHTML = `<div class="muted">ã¾ã é›†è¨ˆãŒã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    list.forEach((u,idx)=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div class="rank"><div class="n">${idx+1}</div><div>${escapeHtml(u.nickname||"unknown")}</div></div>
        <div><b>${Number(u.correctCount||0)}</b></div>
      `;
      leaderboard.appendChild(div);
    });
  }
}

// render all
function renderAll(){
  roomPill.textContent = state.roomId || "-";
  apiBaseText.textContent = API_BASE;

  // participant mode
  if(state.mode==="participant"){
    displayPanel.classList.add("hidden");
    joinPanel.classList.toggle("hidden", !!state.joinToken);
    quizPanel.classList.toggle("hidden", !state.joinToken);

    if(state.joinToken){
      renderQuiz();
      mePill.textContent = state.nickname || "-";
      progressPill.textContent = `${state.voted.size}/7`;
      roomEcho.textContent = state.roomId || "-";
      // æŠ•ç¥¨ãƒœã‚¿ãƒ³ã¯åˆ¥é€”ç”¨æ„ï¼ˆç°¡å˜åŒ–ã®ãŸã‚ choicesã‚¯ãƒªãƒƒã‚¯â†’æŠ•ç¥¨ï¼‰
      // ã“ã“ã§ã¯ choicesã® selected ã‚’æ‹¾ã£ã¦æŠ•ç¥¨ã™ã‚‹UIã«ã™ã‚‹
      // å‚åŠ è€…ãƒ¢ãƒ¼ãƒ‰ã§ã€ŒæŠ•ç¥¨ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ choicesä¸‹ã«å·®ã—è¾¼ã¿
      if(!$("voteBtn")){
        const btn=document.createElement("button");
        btn.id="voteBtn";
        btn.className="primary";
        btn.textContent="æŠ•ç¥¨ã™ã‚‹ï¼ˆ1å›ã ã‘ï¼‰";
        btn.onclick=wireVote;
        btn.style.marginTop="10px";
        choices.parentElement.appendChild(btn);
      }
      $("voteBtn").disabled = state.voted.has(state.currentIndex);
      nextBtn.disabled = (state.currentIndex<QUIZ.length-1) && !state.voted.has(state.currentIndex);
    }
  }else{
    // display mode
    joinPanel.classList.add("hidden");
    quizPanel.classList.add("hidden");
    displayPanel.classList.remove("hidden");
    renderDisplay();
  }
  renderLocalStorage();
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

init();
</script>
</body>
</html>
